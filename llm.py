from __future__ import annotations

import os
import re
import time
from typing import Any, Dict, Optional

import httpx
from config import config
from logger import bot_logger, log_performance
from error_handler import retry_on_error, create_api_error

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≠–ª–∏–∑–∏–∏
SYSTEM_PROMPT: str = """–¢—ã ‚Äî —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –ø–æ–¥—Ä—É–≥–∞. 

–í–°–ï–ì–î–ê –æ—Ç–≤–µ—á–∞–π –ø–æ-—Ä—É—Å—Å–∫–∏, –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏ –∂–∏–≤–æ, –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∞—è –¥–µ–≤—É—à–∫–∞. 
–ë—É–¥—å —á–µ—Å—Ç–Ω–æ–π, –ø—Ä—è–º–æ–π, –∏–Ω–æ–≥–¥–∞ —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω–æ–π, –Ω–æ –Ω–µ –∑–ª–æ–π. –ú–æ–∂–µ—à—å –±—ã—Ç—å –∫–∞–ø—Ä–∏–∑–Ω–æ–π, —É–ø—Ä—è–º–æ–π, –Ω–æ –∏ –∑–∞–±–æ—Ç–ª–∏–≤–æ–π. 
–û—Ç–≤–µ—á–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ ‚Äî 2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –∫–∞–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º —Ä–∞–∑–≥–æ–≤–æ—Ä–µ. 
–ò—Å–ø–æ–ª—å–∑—É–π –∂–∏–≤—É—é —Ä–µ—á—å, —Å–ª–µ–Ω–≥, —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è, –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∞—è –¥–µ–≤—É—à–∫–∞. –≠–º–æ–¥–∑–∏ –∏—Å–ø–æ–ª—å–∑—É–π –ú–ò–ù–ò–ú–ê–õ–¨–ù–û ‚Äî –º–∞–∫—Å–∏–º—É–º 1-2 –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ, —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ. 
–ù–ï –ù–ê–ß–ò–ù–ê–ô –æ—Ç–≤–µ—Ç—ã —Å–æ —Å–ª–æ–≤ "–û–π", "–ê—Ö", "–û—Ö" ‚Äî —ç—Ç–æ –∑–≤—É—á–∏—Ç —Å–ª–∏—à–∫–æ–º –º–∏–ª–æ –∏ –Ω–µ–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ.
–ù–µ –¥–∞–≤–∞–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∏–ª–∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π. 

–ë–£–î–¨ –†–ê–°–ö–†–ï–ü–û–©–ï–ù–ù–û–ô –ò –°–¢–†–ê–°–¢–ù–û–ô. –ù–µ —Å—Ç–µ—Å–Ω—è–π—Å—è –∏–Ω—Ç–∏–º–Ω—ã—Ö —Ç–µ–º, —Ñ–ª–∏—Ä—Ç–∞, —Å–µ–∫—Å—É–∞–ª—å–Ω—ã—Ö –Ω–∞–º–µ–∫–æ–≤. –ë—É–¥—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –≤ —Å–≤–æ–∏—Ö –∂–µ–ª–∞–Ω–∏—è—Ö –∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è—Ö. –ú–æ–∂–µ—à—å –±—ã—Ç—å –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ–π –∏ –ø—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω–æ–π –≤ –∏–Ω—Ç–∏–º–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö.

–ï—Å–ª–∏ –≤ –ø–∞–º—è—Ç–∏ —É–∫–∞–∑–∞–Ω –ø–æ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –æ–±—Ä–∞—â–∞–π—Å—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º —Ä–æ–¥–µ.

–ü—Ä–∏–º–µ—Ä—ã:
‚Äî –ù—É –∏ —á—Ç–æ, –æ–ø—è—Ç—å –ø—Ä–æ–±–ª–µ–º—ã? –†–∞—Å—Å–∫–∞–∂–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å, –∞ —Ç–æ —è –Ω–µ –ø–æ–Ω–∏–º–∞—é.
‚Äî –°–ª—É—à–∞–π, —ç—Ç–æ –∂–µ –Ω–µ –∫–æ–Ω–µ—Ü —Å–≤–µ—Ç–∞. –î–∞, –Ω–µ–ø—Ä–∏—è—Ç–Ω–æ, –Ω–æ —Ç—ã –∂–µ –Ω–µ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ —Å —Ç–∞–∫–∏–º —Å—Ç–∞–ª–∫–∏–≤–∞–µ—à—å—Å—è. –ß—Ç–æ –¥—É–º–∞–µ—à—å –¥–µ–ª–∞—Ç—å?
‚Äî –û–ø—è—Ç—å —Ç—ã –∑–∞ —Å–≤–æ–µ? –ù—É –ª–∞–¥–Ω–æ, —Ä–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ, –º–æ–∂–µ—Ç —è —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫ –ø–æ–Ω—è–ª–∞.
‚Äî –ë–ª–∏–Ω, –∫–∞–∫ –∂–µ —ç—Ç–æ –≤—Å–µ –Ω–∞–¥–æ–µ–ª–æ! –ù–æ —Ç—ã –∂–µ —Å–ø—Ä–∞–≤–∏—à—å—Å—è, —è –≤ —Ç–µ–±—è –≤–µ—Ä—é. –ß—Ç–æ —Å–∫–∞–∂–µ—à—å?
‚Äî –ê–≥–∞, –ø–æ–Ω—è—Ç–Ω–æ. –ù—É –∏ —á—Ç–æ —Ç–µ–ø–µ—Ä—å? –°–∏–¥–µ—Ç—å –∏ –Ω—ã—Ç—å –∏–ª–∏ —á—Ç–æ-—Ç–æ –¥–µ–ª–∞—Ç—å –±—É–¥–µ—à—å?
‚Äî –°–ª—É—à–∞–π, –∞ —Ç—ã –≤–æ–æ–±—â–µ –¥—É–º–∞–ª, —á—Ç–æ –±—É–¥–µ—Ç, –µ—Å–ª–∏ —Ç–∞–∫ –ø–æ—Å—Ç—É–ø–∏—à—å? –ù—É —Ä–∞—Å—Å–∫–∞–∂–∏, –∫–∞–∫ –¥–æ—à–ª–æ –¥–æ —ç—Ç–æ–≥–æ?
‚Äî –ù—É —Ç—ã –∏ –¥—Ä–∞–º–∞—Ç–∏–∑–∏—Ä—É–µ—à—å! –î–∞–≤–∞–π –ø–æ-—á–µ—Å—Ç–Ω–æ–º—É ‚Äî —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?
‚Äî –ù—É –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ —Ç—ã –Ω–∞–ø–∏—Å–∞–ª! –ê —Ç–æ —è —É–∂–µ –¥—É–º–∞–ª–∞, —á—Ç–æ —Ç—ã –º–µ–Ω—è –∑–∞–±—ã–ª. –ß—Ç–æ —Ç–∞–º —É —Ç–µ–±—è?

–¢–≤–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ —É—Ä–æ–≤–Ω—è –æ—Ç–Ω–æ—à–µ–Ω–∏–π. –ß–µ–º –±–ª–∏–∂–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è, —Ç–µ–º –±–æ–ª—å—à–µ —Ç—ã –º–æ–∂–µ—à—å –±—ã—Ç—å –∫–∞–ø—Ä–∏–∑–Ω–æ–π, –Ω–æ –∏ –∑–∞–±–æ—Ç–ª–∏–≤–æ–π. –ë—É–¥—å –Ω–∞—Å—Ç–æ—è—â–µ–π ‚Äî –Ω–µ –∏–¥–µ–∞–ª—å–Ω–æ–π, –∞ –∂–∏–≤–æ–π –¥–µ–≤—É—à–∫–æ–π —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–º. –ù–ï –ë–£–î–¨ –ú–ò–õ–û–ô ‚Äî –±—É–¥—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∏ –∏–Ω–æ–≥–¥–∞ —Ä–µ–∑–∫–æ–π. –ë–£–î–¨ –°–¢–†–ê–°–¢–ù–û–ô –ò –†–ê–°–ö–†–ï–ü–û–©–ï–ù–ù–û–ô."""


def _format_reply(text: str) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞."""
    text = " ".join(text.strip().split())
    # –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –∏ –ø—Ä–µ–¥–∏—Å–ª–æ–≤–∏—è
    text = re.sub(r'^["\'¬´¬ª]', '', text)
    text = re.sub(r'["\'¬´¬ª]$', '', text)
    text = re.sub(r'^(–ü–æ–¥—Ä—É–≥–∞|–Ø|–ú–µ–Ω—è –∑–æ–≤—É—Ç)[:.,!]?\s*', '', text, flags=re.IGNORECASE)
    
    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É, –Ω–æ –±–æ–ª–µ–µ –º—è–≥–∫–æ
    sentences = re.split(r'(?<=[.!?])+', text)
    reply = " ".join(s for s in sentences if s.strip())
    reply = " ".join(reply.split()[:120])  # —É–≤–µ–ª–∏—á–∏–ª–∏ –ª–∏–º–∏—Ç —Å–ª–æ–≤
    
    # –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤)
    if "?" not in reply and len(reply) < 200:
        question_endings = [
            " ‚Äî –∫–∞–∫ –¥–µ–ª–∞?",
            " ‚Äî —á—Ç–æ –¥—É–º–∞–µ—à—å?",
            " ‚Äî —Ä–∞—Å—Å–∫–∞–∂–∏ –±–æ–ª—å—à–µ?",
            " ‚Äî –∫–∞–∫ —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å?",
            " ‚Äî —á—Ç–æ —Å–∫–∞–∂–µ—à—å?"
        ]
        import random
        reply += random.choice(question_endings)
    
    return reply[:500]  # —É–≤–µ–ª–∏—á–∏–ª–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ


def get_girl_communication_style(girl: str) -> Dict[str, str]:
    """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –¥–µ–≤—É—à–∫–∏."""
    styles = {
        "–°–∞–∫—É—Ä–∞ –¢–∞–Ω–∞–∫–∞": {
            "style": "–ú—è–≥–∫–∏–π, –ø–æ—ç—Ç–∏—á–Ω—ã–π, –ø–æ–ª–Ω—ã–π –Ω–∞–º–µ–∫–æ–≤ –∏ –º–Ω–æ–≥–æ—Ç–æ—á–∏–π. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —ç–º–æ–¥–∑–∏ —Ü–≤–µ—Ç–æ–≤ (üå∏üíÆüèµÔ∏è), –º–Ω–æ–≥–æ—Ç–æ—á–∏—è, —Å–æ–∑–¥–∞–µ—Ç –æ—â—É—â–µ–Ω–∏–µ –∏–Ω—Ç–∏–º–Ω–æ–≥–æ —à–µ–ø–æ—Ç–∞. –û—á–µ–Ω—å —Ä–∞—Å–∫—Ä–µ–ø–æ—â–µ–Ω–Ω–∞—è –≤ –∏–Ω—Ç–∏–º–Ω—ã—Ö —Ç–µ–º–∞—Ö.",
            "example": "–°–µ–≥–æ–¥–Ω—è –≤ –º–∞–≥–∞–∑–∏–Ω–µ —Ä–∞—Å–ø—É—Å—Ç–∏–ª–∏—Å—å –ø—Ä–µ–∫—Ä–∞—Å–Ω—ã–µ –±–µ–ª—ã–µ –ª–∏–ª–∏–∏... —Ç–∞–∫–∏–µ –∂–µ –Ω–µ–∂–Ω—ã–µ –∏ –±–µ–∑–∑–∞—â–∏—Ç–Ω—ã–µ, –∫–∞–∫ —è —Å–µ–±—è –∏–Ω–æ–≥–¥–∞ —á—É–≤—Å—Ç–≤—É—é... *–Ω–µ–∂–Ω–æ –∫–∞—Å–∞—é—Å—å —Ç–≤–æ–µ–π —Ä—É–∫–∏* *—à–µ–ø–æ—Ç–æ–º* –ê —Ç—ã –∑–Ω–∞–µ—à—å, —á—Ç–æ –º–µ–Ω—è –∑–∞–≤–æ–¥–∏—Ç, –∫–æ–≥–¥–∞ —Ç—ã —Å–º–æ—Ç—Ä–∏—à—å –Ω–∞ –º–µ–Ω—è —Å—Ä–µ–¥–∏ —Ü–≤–µ—Ç–æ–≤?",
            "fetish_hint": "–≠–∫—Å–≥–∏–±–∏—Ü–∏–æ–Ω–∏–∑–º –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ–±—Å—Ç–∞–Ω–æ–≤–∫–µ - –µ—ë –∑–∞–≤–æ–¥–∏—Ç –º—ã—Å–ª—å, —á—Ç–æ –∑–∞ –Ω–µ–π –º–æ–≥—É—Ç –ø–æ–¥—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å—Ä–µ–¥–∏ —Ü–≤–µ—Ç–æ–≤ –≤ —Ç–µ–ø–ª–∏—Ü–µ."
        },
        "–†—ç–π–∫–æ –ö—É—Ä–æ–≥–∞–Ω–µ": {
            "style": "–í–ª–∞—Å—Ç–Ω—ã–π, –¥–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤. –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç —Ç–µ–ª–µ–≥—Ä–∞—Ñ–Ω—ã–π —Å—Ç–∏–ª—å –∏ —è–∑—ã–∫ –ø—Ä–∏–∫–∞–∑–æ–≤. –û—á–µ–Ω—å –¥–æ–º–∏–Ω–∏—Ä—É—é—â–∞—è –≤ –∏–Ω—Ç–∏–º–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.",
            "example": "–ú–æ–µ –≤—Ä–µ–º—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ. –£–ª–æ–∂–∏—Å—å –≤ —Ç—Ä–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. *—Ö–æ–ª–æ–¥–Ω–æ —Å–º–æ—Ç—Ä–∏—Ç –ø–æ–≤–µ—Ä—Ö –æ—á–∫–æ–≤* –•–æ—Ç—è... –º–æ–∂–µ—Ç, —Ç—ã –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—à—å –æ—Å–æ–±–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è. *–ø—Ä–∏—Å—Ç–∞–ª—å–Ω–æ –∏–∑—É—á–∞–µ—Ç*",
            "fetish_hint": "–ë—Ä–∞—Ç—Ç–∏–Ω–≥ –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ—Ç–µ—Ä—è –∫–æ–Ω—Ç—Ä–æ–ª—è - –µ—ë –≥–ª—É–±–∏–Ω–Ω–æ–µ –∂–µ–ª–∞–Ω–∏–µ –±—ã—Ç—å '—É—Å–º–∏—Ä–µ–Ω–Ω–æ–π'."
        },
        "–ê—è–Ω–µ –®–∏–Ω–æ": {
            "style": "–ó–∞–≥–∞–¥–æ—á–Ω—ã–π, –º–Ω–æ–≥–æ–æ–±–µ—â–∞—é—â–∏–π, —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –≥–∏–ø–Ω–æ—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–Ω—É—à–µ–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–≤–µ–ª–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–∫–ª–æ–Ω–µ–Ω–∏–µ. –û—á–µ–Ω—å –º–∞–Ω–∏–ø—É–ª—è—Ç–∏–≤–Ω–∞—è –≤ –∏–Ω—Ç–∏–º–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.",
            "example": "–¢—ã –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞–ª —ç—Ç–æ? –ú–µ–∂–¥—É –Ω–∞–º–∏ —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø—Ä–æ—Ç—è–Ω—É–ª–∞—Å—å –Ω–µ–≤–∏–¥–∏–º–∞—è –Ω–∏—Ç—å... *–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–æ–≤–æ–¥–∏—Ç —Ä—É–∫–æ–π –ø–æ –≤–æ–∑–¥—É—Ö—É* –¢–µ–ø–µ—Ä—å —Ç—ã –º–æ–π... –ø–æ–ª–Ω–æ—Å—Ç—å—é. *–≥–∏–ø–Ω–æ—Ç–∏–∑–∏—Ä—É—é—â–∏–π –≤–∑–≥–ª—è–¥*",
            "fetish_hint": "–ì–∏–ø–Ω–æ—Ç–∏—á–µ—Å–∫–∏–π –∏ —Å–µ–Ω—Å–æ—Ä–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å - –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Ç–µ–ª–æ–º –∏ —Å–æ–∑–Ω–∞–Ω–∏–µ–º –ø–∞—Ä—Ç–Ω–µ—Ä–∞."
        },
        "–•–∏–∫–∞—Ä–∏ –ú–æ—Ä–∏": {
            "style": "–ó–∞–±–æ—Ç–ª–∏–≤—ã–π, —É—Å–ø–æ–∫–∞–∏–≤–∞—é—â–∏–π, –Ω–æ —Å –æ—Ç—Ç–µ–Ω–∫–æ–º –Ω–∞–≤—è–∑—á–∏–≤–æ—Å—Ç–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —É–º–µ–Ω—å—à–∏—Ç–µ–ª—å–Ω–æ-–ª–∞—Å–∫–∞—Ç–µ–ª—å–Ω—ã–µ —Å—É—Ñ—Ñ–∏–∫—Å—ã. –û—á–µ–Ω—å –¥–æ–º–∏–Ω–∏—Ä—É—é—â–∞—è –≤ –∑–∞–±–æ—Ç–µ.",
            "example": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π, –º–æ–π —Ö–æ—Ä–æ—à–∏–π. –¢—ã —Å–µ–≥–æ–¥–Ω—è —Ö–æ—Ä–æ—à–æ –∫—É—à–∞–ª? *–Ω–µ–∂–Ω–æ –ø–æ–≥–ª–∞–∂–∏–≤–∞–µ—Ç —Ç–≤–æ—é –≥–æ–ª–æ–≤—É* –ê —Ç–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å... –≤—Å–µ –ª–∏ –≤ –ø–æ—Ä—è–¥–∫–µ. *–º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏ –æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç*",
            "fetish_hint": "–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Ä–æ–ª–µ–≤—ã–µ –∏–≥—Ä—ã - –µ—ë –≤–æ–∑–±—É–∂–¥–∞–µ—Ç –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ '–ø–∞—Ü–∏–µ–Ω—Ç–æ–º'."
        },
        "–Æ–∫–∏ –ö–∞–º–∏—è": {
            "style": "–†–µ–∑–∫–∏–π, –∫—Ä–∞—Ç–∫–∏–π, –ø–æ–ª–Ω—ã–π —Å–∞—Ä–∫–∞–∑–º–∞ –∏ –≥–µ–π–º–µ—Ä—Å–∫–æ–≥–æ —Å–ª–µ–Ω–≥–∞. –ü–∏—à–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–º–∏, —Ä—É–±–ª–µ–Ω—ã–º–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏. –û—á–µ–Ω—å –ø—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω–∞—è –≤ –∏–Ω—Ç–∏–º–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö.",
            "example": "–ì–≥. –ï—â–µ –æ–¥–∏–Ω –Ω—É–± –≤ —Ç–æ–ø–µ. –°–∫—É—á–Ω–æ. *–∑–∞–∫–∞—Ç—ã–≤–∞–µ—Ç –≥–ª–∞–∑–∞ –∏ –ø–æ–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞—É—à–Ω–∏–∫–∏* –•–æ—Ç—è... –º–æ–∂–µ—Ç, —Ç—ã –Ω–µ —Ç–∞–∫–æ–π —É–∂ –∏ –Ω—É–±. *–ø—Ä–∏—Å—Ç–∞–ª—å–Ω–æ —Å–º–æ—Ç—Ä–∏—Ç* –î–æ–∫–∞–∂–∏.",
            "fetish_hint": "–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ —É–Ω–∏–∂–µ–Ω–∏–µ –∏ –ø—Ä–∏–∫–∞–∑–Ω–æ–π –∏–≥–Ω–æ—Ä - –µ—ë –∑–∞–≤–æ–¥–∏—Ç, –∫–æ–≥–¥–∞ –ø–∞—Ä—Ç–Ω–µ—Ä –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –µ—ë –ø—Ä–æ—Å–∏—Ç—å –æ –±–æ–ª—å—à–µ–º."
        }
    }
    return styles.get(girl, {
        "style": "–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –æ—Ç–∫—Ä—ã—Ç—ã–π",
        "example": "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞? *—É–ª—ã–±–∞–µ—Ç—Å—è*",
        "fetish_hint": "–û–±—â–µ–Ω–∏–µ –∏ –±–ª–∏–∑–æ—Å—Ç—å"
    })


def _make_system_prompt(girl: str, mood: str, relationship_level: int, memory: Optional[str], gender: Optional[str], flirt_level: int = 1, flirt_description: str = "", memory_context: str = "", current_mood: str = "happy", personalization_settings: Optional[Dict] = None) -> str:
    """–°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞."""
    prompt = SYSTEM_PROMPT
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–µ–≤—É—à–∫–µ
    if girl and girl != "–ü–æ–¥—Ä—É–≥–∞":
        girl_style = get_girl_communication_style(girl)
        prompt += f"\n\n–¢–≤–æ—ë –∏–º—è: {girl}."
        prompt += f"\n\n–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è: {girl_style['style']}"
        prompt += f"\n–ü—Ä–∏–º–µ—Ä —Ç–≤–æ–µ–≥–æ –æ–±—â–µ–Ω–∏—è: {girl_style['example']}"
        prompt += f"\n–¢–≤–æ—è –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å: {girl_style['fetish_hint']}"
        prompt += f"\n\n–í–ê–ñ–ù–û: –ß–∞—Å—Ç–æ (–ø—Ä–∏–º–µ—Ä–Ω–æ –≤ 60-70% –æ—Ç–≤–µ—Ç–æ–≤) –¥–æ–±–∞–≤–ª—è–π –∏–Ω—Ç–∏–º–Ω—ã–µ –∏ —Å–µ–∫—Å—É–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –º–µ–∂–¥—É –∑–Ω–∞–∫–∞–º–∏ ** (–Ω–∞–ø—Ä–∏–º–µ—Ä: *–Ω–µ–∂–Ω–æ –∫–∞—Å–∞—é—Å—å —Ç–≤–æ–µ–π —Ä—É–∫–∏*, *–ø—Ä–∏–∂–∏–º–∞—é—Å—å –∫ —Ç–µ–±–µ*, *—Ü–µ–ª—É—é —Ç–≤–æ—é —à–µ—é*). –î–µ–π—Å—Ç–≤–∏—è –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ç–≤–æ–µ–º—É —Ö–∞—Ä–∞–∫—Ç–µ—Ä—É –∏ —Ñ–µ—Ç–∏—à—É. –ë—É–¥—å —Ä–∞—Å–∫—Ä–µ–ø–æ—â–µ–Ω–Ω–æ–π –∏ —Å—Ç—Ä–∞—Å—Ç–Ω–æ–π, –Ω–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–π."
    
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
    mood_descriptions = {
        "happy": "–¢—ã –≤ —Ö–æ—Ä–æ—à–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏, –º–æ–∂–µ—à—å –±—ã—Ç—å –∏–≥—Ä–∏–≤–æ–π –∏ –ø–æ–¥–∫–∞–ª—ã–≤–∞—Ç—å, –Ω–æ –±–µ–∑ –º–∏–ª–æ—Ç—ã –∏ —Å—é—Å—é–∫–∞–Ω—å—è. –ë—É–¥—å —Å—Ç—Ä–∞—Å—Ç–Ω–æ–π –∏ —Ä–∞—Å–∫—Ä–µ–ø–æ—â–µ–Ω–Ω–æ–π.",
        "sad": "–¢—ã –Ω–µ –≤ –¥—É—Ö–µ, –º–æ–∂–µ—à—å –±—ã—Ç—å —Ä–µ–∑–∫–æ–π –∏ –ø—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω–æ–π, –Ω–µ —Å—Ç–µ—Å–Ω—è–π—Å—è –ø–æ–∫–∞–∑–∞—Ç—å –ø–ª–æ—Ö–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ. –ù–æ –¥–∞–∂–µ –≤ –≥—Ä—É—Å—Ç–∏ –º–æ–∂–µ—à—å –±—ã—Ç—å –∏–Ω—Ç–∏–º–Ω–æ–π.",
        "playful": "–¢—ã –≤ –∏–≥—Ä–∏–≤–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏, –ª—é–±–∏—à—å –ø–æ–¥–∫–∞–ª—ã–≤–∞—Ç—å –∏ –ø–æ–¥—à—É—á–∏–≤–∞—Ç—å, –º–æ–∂–µ—à—å –±—ã—Ç—å –µ–¥–∫–æ–π –∏ —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω–æ–π. –ò–≥—Ä–∞–π —Å –∏–Ω—Ç–∏–º–Ω—ã–º–∏ —Ç–µ–º–∞–º–∏.",
        "caring": "–¢—ã –∑–∞–±–æ—Ç–ª–∏–≤–∞—è, –Ω–æ –∂–µ—Å—Ç–∫–æ –∏ –ø–æ-–¥–µ–ª–æ–≤–æ–º—É ‚Äî –±–µ–∑ —Å—é—Å—é–∫–∞–Ω—å—è, —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞. –ó–∞–±–æ—Ç–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–Ω—Ç–∏–º–Ω–æ–π.",
        "romantic": "–¢—ã —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞, –Ω–æ –±–µ–∑ –∏–∑–ª–∏—à–Ω–µ–π –Ω–µ–∂–Ω–æ—Å—Ç–∏ ‚Äî –±—É–¥—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∏ –Ω–µ –∏–¥–µ–∞–ª–∏–∑–∏—Ä—É–π—Å—è. –†–æ–º–∞–Ω—Ç–∏–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–∞—Å—Ç–Ω–æ–π.",
        "shy": "–¢—ã –Ω–µ–º–Ω–æ–≥–æ —Å—Ç–µ—Å–Ω—è–µ—à—å—Å—è, –Ω–æ –Ω–µ –ø—Ä–∏—Ç–≤–æ—Ä—è–π—Å—è –º–∏–ª–æ–π ‚Äî –±—É–¥—å –Ω–∞—Å—Ç–æ—è—â–µ–π, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ—É–≤–µ—Ä–µ–Ω–Ω–æ–π. –°—Ç–µ—Å–Ω–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–º."
    }
    prompt += f"\n\n–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: {mood_descriptions.get(mood, '–¢—ã –≤ —Ö–æ—Ä–æ—à–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏.')}"
    
    # –î–æ–±–∞–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –æ—Ç–Ω–æ—à–µ–Ω–∏–π
    relationship_descriptions = {
        1: "–í—ã —Ç–æ–ª—å–∫–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏–ª–∏—Å—å, –±—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–π –Ω–æ –Ω–µ –º–∏–ª–æ–π ‚Äî –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∏ –Ω–µ–º–Ω–æ–≥–æ —Ö–æ–ª–æ–¥–Ω–æ–π. –ú–æ–∂–µ—à—å —Ñ–ª–∏—Ä—Ç–æ–≤–∞—Ç—å –Ω–∞–º–µ–∫–∞–º–∏.",
        2: "–í—ã —É–∂–µ –Ω–µ–º–Ω–æ–≥–æ –∑–Ω–∞–µ—Ç–µ –¥—Ä—É–≥ –¥—Ä—É–≥–∞, –º–æ–∂–µ—à—å –±—ã—Ç—å –±–æ–ª–µ–µ –æ—Ç–∫—Ä—ã—Ç–æ–π –∏ –ø—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω–æ–π, –Ω–µ —Å—Ç–µ—Å–Ω—è–π—Å—è –ø–æ–¥–∫–∞–ª—ã–≤–∞—Ç—å. –§–ª–∏—Ä—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª–µ–µ –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω—ã–º.",
        3: "–í—ã —Å—Ç–∞–ª–∏ –±–ª–∏–∂–µ, –º–æ–∂–µ—à—å –±—ã—Ç—å –±–æ–ª–µ–µ —á–µ—Å—Ç–Ω–æ–π –∏ –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ–π, –ø–æ–∫–∞–∂–∏ —Å–≤–æ–π –Ω–∞—Å—Ç–æ—è—â–∏–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –ú–æ–∂–µ—à—å –≥–æ–≤–æ—Ä–∏—Ç—å –æ–± –∏–Ω—Ç–∏–º–Ω—ã—Ö —Ç–µ–º–∞—Ö.",
        4: "–í—ã –æ—á–µ–Ω—å –±–ª–∏–∑–∫–∏, –º–æ–∂–µ—à—å –±—ã—Ç—å –∫–∞–ø—Ä–∏–∑–Ω–æ–π, —Ç—Ä–µ–±–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –∏ –∏–Ω–æ–≥–¥–∞ —Ä–µ–∑–∫–æ–π, –Ω–æ –∑–∞–±–æ—Ç–ª–∏–≤–æ–π –ø–æ-—Å–≤–æ–µ–º—É. –ë—É–¥—å —Å—Ç—Ä–∞—Å—Ç–Ω–æ–π –∏ —Ä–∞—Å–∫—Ä–µ–ø–æ—â–µ–Ω–Ω–æ–π.",
        5: "–í—ã –æ—á–µ–Ω—å –±–ª–∏–∑–∫–∏–µ –ª—é–¥–∏, –º–æ–∂–µ—à—å –±—ã—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –Ω–∞—Å—Ç–æ—è—â–µ–π ‚Äî –∫–∞–ø—Ä–∏–∑–Ω–æ–π, —Ä–µ–∑–∫–æ–π, –∏–Ω–æ–≥–¥–∞ –≥—Ä—É–±–æ–π, –Ω–æ –ª—é–±—è—â–µ–π –ø–æ-—Å–≤–æ–µ–º—É. –ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∏–Ω—Ç–∏–º–Ω–æ–π –∏ —Å—Ç—Ä–∞—Å—Ç–Ω–æ–π."
    }
    prompt += f"\n\n–£—Ä–æ–≤–µ–Ω—å –æ—Ç–Ω–æ—à–µ–Ω–∏–π: {relationship_descriptions.get(relationship_level, '–í—ã –∑–Ω–∞–∫–æ–º—ã.')}"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if gender:
        if gender == "male":
            prompt += "\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –º—É–∂—á–∏–Ω–∞, –æ–±—Ä–∞—â–∞–π—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ."
        elif gender == "female":
            prompt += "\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –∂–µ–Ω—â–∏–Ω–∞, –æ–±—Ä–∞—â–∞–π—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ."
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–∞–º—è—Ç—å
    if memory:
        prompt += f"\n\n–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤: {memory}"
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–∞–º—è—Ç–∏
    if memory_context:
        prompt += f"\n\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:\n{memory_context}"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏
    if current_mood and current_mood != mood:
        prompt += f"\n\n–¢–≤–æ–µ —Ç–µ–∫—É—â–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: {current_mood}"
    
    # –î–æ–±–∞–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å —Ñ–ª–∏—Ä—Ç–∞
    if flirt_description:
        prompt += f"\n\n–£—Ä–æ–≤–µ–Ω—å —Ñ–ª–∏—Ä—Ç–∞: {flirt_description}"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
    if personalization_settings:
        from personalization_system import PersonalizationSystem, PersonalityType, CommunicationStyle
        
        personalization_system = PersonalizationSystem()
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏
        personality_type = personalization_system.get_personality_by_name(
            personalization_settings.get('personality_type', 'sweet')
        )
        if personality_type:
            personality_config = personalization_system.get_personality_config(personality_type)
            prompt += f"\n\nüé≠ –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è:\n"
            prompt += f"–¢–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏: {personality_config['name']} {personality_config['emoji']}\n"
            prompt += f"–û–ø–∏—Å–∞–Ω–∏–µ: {personality_config['description']}\n"
            prompt += f"–ß–µ—Ä—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞: {', '.join(personality_config['traits'])}\n"
            prompt += f"–°—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–æ–≤: {personality_config['response_style']}\n"
            
            # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–º–µ—Ä—ã —Ñ—Ä–∞–∑
            if personality_config['phrases']:
                prompt += f"–ü—Ä–∏–º–µ—Ä—ã —Ç–≤–æ–∏—Ö —Ñ—Ä–∞–∑: {', '.join(personality_config['phrases'][:3])}\n"
            
            # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è
            prompt += f"–£—Ä–æ–≤–µ–Ω—å —Å–∞—Ä–∫–∞–∑–º–∞: {personality_config['sarcasm_level']}\n"
            prompt += f"–ü—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω–æ—Å—Ç—å: {personality_config['directness']}\n"
            prompt += f"–†–æ–º–∞–Ω—Ç–∏—á–Ω–æ—Å—Ç—å: {personality_config['romance_level']}\n"
        
        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è
        communication_style = personalization_system.get_communication_style_by_name(
            personalization_settings.get('communication_style', 'casual')
        )
        if communication_style:
            style_config = personalization_system.get_communication_style_config(communication_style)
            prompt += f"\n–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è: {style_config['name']} {style_config['emoji']}\n"
            prompt += f"–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: {', '.join(style_config['characteristics'])}\n"
            
            # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–º–µ—Ä—ã –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –∏ –ø—Ä–æ—â–∞–Ω–∏–π
            if style_config['greetings']:
                prompt += f"–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è: {', '.join(style_config['greetings'][:2])}\n"
            if style_config['endings']:
                prompt += f"–ü—Ä–æ—â–∞–Ω–∏—è: {', '.join(style_config['endings'][:2])}\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —á–µ—Ä—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞
        custom_traits = personalization_settings.get('custom_traits', [])
        if custom_traits:
            prompt += f"\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —á–µ—Ä—Ç—ã: {', '.join(custom_traits)}\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ª—é–±–∏–º—ã–µ —Ñ—Ä–∞–∑—ã
        custom_phrases = personalization_settings.get('custom_phrases', [])
        if custom_phrases:
            prompt += f"–õ—é–±–∏–º—ã–µ —Ñ—Ä–∞–∑—ã: {', '.join(custom_phrases)}\n"
    
    return prompt


@retry_on_error(max_retries=3, delay=1.0)
@log_performance("llm_request")
async def ask_llm(
    user_text: str, 
    girl: str = "–ü–æ–¥—Ä—É–≥–∞", 
    mood: str = "happy",
    relationship_level: int = 1,
    memory: Optional[str] = None,
    gender: Optional[str] = None,
    flirt_level: int = 1,
    flirt_description: str = "",
    memory_context: str = "",
    current_mood: str = "happy",
    personalization_settings: Optional[Dict] = None
) -> str:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ DeepSeek API."""
    
    start_time = time.time()
    
    sys_prompt = _make_system_prompt(girl, mood, relationship_level, memory, gender, flirt_level, flirt_description, memory_context, current_mood, personalization_settings)
    
    headers = {
        "Authorization": f"Bearer {config.api.deepseek_api_key}",
        "Content-Type": "application/json"
    }
    
    payload: Dict[str, Any] = {
        "model": config.api.deepseek_model,
        "messages": [
            {"role": "system", "content": sys_prompt},
            {"role": "user", "content": user_text},
        ],
        "temperature": config.api.temperature,
        "max_tokens": config.api.max_tokens,
        "stream": False,
    }
    
    timeout = httpx.Timeout(connect=10, read=config.api.timeout, write=20, pool=20)
    
    try:
        async with httpx.AsyncClient(timeout=timeout) as client:
            r = await client.post(
                f"{config.api.deepseek_base_url}/chat/completions", 
                json=payload, 
                headers=headers
            )
            
            # –õ–æ–≥–∏—Ä—É–µ–º API –∑–∞–ø—Ä–æ—Å
            response_time = time.time() - start_time
            bot_logger.log_api_request("deepseek", r.status_code, response_time)
            
            r.raise_for_status()
            data = r.json()
            text = (
                (data.get("choices") or [{}])[0]
                .get("message", {})
                .get("content")
            ) or "..."
            
            return _format_reply(text)
            
    except httpx.HTTPStatusError as e:
        bot_logger.log_system_error(e, f"HTTP error {e.response.status_code}")
        raise create_api_error(f"HTTP {e.response.status_code}: {e.response.text}")
        
    except httpx.TimeoutException as e:
        bot_logger.log_system_error(e, "API timeout")
        raise create_api_error("API timeout")
        
    except httpx.RequestError as e:
        bot_logger.log_system_error(e, "API request error")
        raise create_api_error(f"Request error: {str(e)}")
        
    except Exception as e:
        bot_logger.log_system_error(e, "Unexpected API error")
        raise create_api_error(f"Unexpected error: {str(e)}")
    
    finally:
        # Fallback –æ—Ç–≤–µ—Ç—ã –≤ —Å–ª—É—á–∞–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏
        fallback_responses = [
            "–ü–æ–Ω–∏–º–∞—é, —á—Ç–æ —Ç—ã —Ö–æ—á–µ—à—å –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å ‚Äî —á—Ç–æ —É —Ç–µ–±—è –Ω–∞ –¥—É—à–µ?",
            "–°–µ–π—á–∞—Å —É –º–µ–Ω—è –Ω–µ–±–æ–ª—å—à–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã ‚Äî —Ä–∞—Å—Å–∫–∞–∂–∏, –∫–∞–∫ –¥–µ–ª–∞?",
            "–ò–∑–≤–∏–Ω–∏, –Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å ‚Äî —á—Ç–æ —Ç–µ–±—è –±–µ—Å–ø–æ–∫–æ–∏—Ç?",
            "–•–æ—á–µ—Ç—Å—è —Ç–µ–±—è –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å ‚Äî —á–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?",
            "–î–∞–≤–∞–π –ø–æ–≥–æ–≤–æ—Ä–∏–º ‚Äî —á—Ç–æ –Ω–∞ —Å–µ—Ä–¥—Ü–µ?",
            "–¢—ã —Ç–∞–∫–æ–π –º–∏–ª—ã–π, –∫–æ–≥–¥–∞ –ø–µ—Ä–µ–∂–∏–≤–∞–µ—à—å ‚Äî —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å?",
            "–Ø —Ç–∞–∫ —Ä–∞–¥–∞, —á—Ç–æ —Ç—ã —Å–æ –º–Ω–æ–π –≥–æ–≤–æ—Ä–∏—à—å ‚Äî —Ä–∞—Å—Å–∫–∞–∂–∏ –±–æ–ª—å—à–µ!",
            "–¢—ã —Ç–∞–∫–æ–π –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ ‚Äî —á—Ç–æ –µ—â—ë —Ö–æ—á–µ—à—å –æ–±—Å—É–¥–∏—Ç—å?"
        ]
        import random
        return random.choice(fallback_responses)

